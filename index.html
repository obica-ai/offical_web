<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>城际同行平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .fade-in { 
            animation: fadeIn 0.5s ease-in-out; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        input, select, textarea {
            transition: all 0.2s;
        }
        input:focus, select:focus, textarea:focus {
            ring-2 ring-blue-500 ring-opacity-50;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg"></div>
                    <h1 class="text-xl font-bold text-gray-900">城际同行</h1>
                </div>
                <nav class="flex space-x-6">
                    <button onclick="showSection('passenger')" class="text-gray-600 hover:text-gray-900">乘客</button>
                    <button onclick="showSection('driver')" class="text-gray-600 hover:text-gray-900">司机</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Auth Section -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div id="auth-section" class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-lg font-semibold">用户登录</h2>
                    <p class="text-gray-600 text-sm">请登录后使用平台功能</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="user-status" class="text-sm text-gray-600">未登录</span>
                    <span id="user-id" class="hidden text-xs text-gray-500"></span>
                    <button id="profile-btn" class="hidden px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50">个人资料</button>
                    <button id="logout-btn" class="hidden px-4 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-50">退出</button>
                </div>
            </div>
            
            <div id="login-form" class="mt-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input 
                        id="email-input" 
                        type="email" 
                        placeholder="输入邮箱地址" 
                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <input 
                        id="password-input" 
                        type="password" 
                        placeholder="输入密码" 
                        class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div class="flex space-x-2">
                    <button 
                        id="login-btn" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        登录
                    </button>
                    <button 
                        id="register-btn" 
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500"
                    >
                        注册
                    </button>
                </div>
            </div>
        </div>

        <!-- User Type Selection -->
        <div id="user-type-section" class="hidden bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">选择用户类型</h3>
            <div class="flex space-x-4">
                <button 
                    id="passenger-type-btn" 
                    class="px-6 py-3 border border-gray-300 rounded-md hover:bg-blue-50 hover:border-blue-300"
                >
                    我是乘客
                </button>
                <button 
                    id="driver-type-btn" 
                    class="px-6 py-3 border border-gray-300 rounded-md hover:bg-green-50 hover:border-green-300"
                >
                    我是司机
                </button>
            </div>
        </div>

        <!-- User Profile Section -->
        <div id="profile-section" class="hidden bg-white rounded-lg shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">个人资料</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <input id="profile-name" type="text" placeholder="真实姓名" class="px-3 py-2 border border-gray-300 rounded-md">
                <input id="profile-phone" type="tel" placeholder="手机号码" class="px-3 py-2 border border-gray-300 rounded-md">
                <input id="profile-id-number" type="text" placeholder="身份证号码" class="px-3 py-2 border border-gray-300 rounded-md">
                <select id="profile-gender" class="px-3 py-2 border border-gray-300 rounded-md">
                    <option value="">选择性别</option>
                    <option value="male">男</option>
                    <option value="female">女</option>
                </select>
                <input id="profile-age" type="number" placeholder="年龄" min="18" max="100" class="px-3 py-2 border border-gray-300 rounded-md">
                <textarea id="profile-bio" placeholder="个人简介" class="px-3 py-2 border border-gray-300 rounded-md"></textarea>
            </div>
            <button id="save-profile-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">保存资料</button>
        </div>

        <!-- Passenger Section -->
        <div id="passenger-section" class="hidden">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">乘客 - 发布行程需求</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <input id="passenger-from" type="text" placeholder="出发城市" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="passenger-to" type="text" placeholder="目的城市" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="passenger-date" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="passenger-time" type="time" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="passenger-seats" type="number" placeholder="需要座位数" min="1" max="8" class="px-3 py-2 border border-gray-300 rounded-md">
                    <textarea id="passenger-note" placeholder="备注信息" class="px-3 py-2 border border-gray-300 rounded-md col-span-full"></textarea>
                </div>
                <button id="add-passenger-request" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">发布需求</button>
            </div>

            <!-- Search Available Drivers -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4">搜索可用司机</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input id="search-from" type="text" placeholder="出发城市" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="search-to" type="text" placeholder="目的城市" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="search-date" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <button id="search-drivers" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">搜索司机</button>
                <div id="driver-results" class="mt-4 space-y-3"></div>
            </div>

            <!-- My Requests -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4">我的行程需求</h3>
                <div id="passenger-requests" class="space-y-3"></div>
            </div>
        </div>

        <!-- Driver Section -->
        <div id="driver-section" class="hidden">
            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">司机 - 发布可用时间表</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <input id="driver-from" type="text" placeholder="出发城市" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="driver-to" type="text" placeholder="目的城市" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="driver-date" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="driver-time" type="time" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="driver-seats" type="number" placeholder="可载人数" min="1" max="8" class="px-3 py-2 border border-gray-300 rounded-md">
                    <input id="driver-price" type="number" placeholder="每人价格(元)" min="0" class="px-3 py-2 border border-gray-300 rounded-md">
                    <textarea id="driver-note" placeholder="备注信息" class="px-3 py-2 border border-gray-300 rounded-md col-span-full"></textarea>
                </div>
                <button id="add-driver-schedule" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">发布时间表</button>
            </div>

            <!-- My Schedules -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4">我的行程时间表</h3>
                <div id="driver-schedules" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://ddycdlhhgezffmybssvw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkeWNkbGhoZ2V6ZmZteWJzc3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NDA4MzAsImV4cCI6MjA3MjExNjgzMH0.JAU94T7uUZQCvuXtaZbMc3VXTAKQyprTX0H62AGOtyo';
        
        // Initialize Supabase client
        let supabaseClient;
        let currentUser = null;
        let userProfile = null;
        let userType = null;

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            try {
                // Check if supabase is available
                if (typeof supabase === 'undefined') {
                    console.error('Supabase library not loaded');
                    showMessage('系统初始化失败，请刷新页面重试', 'error');
                    return;
                }

                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                setupEventListeners();
                checkAuthState();
                
                // Listen for auth state changes
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    try {
                        if (event === 'SIGNED_IN') {
                            currentUser = session.user;
                            updateAuthUI();
                            await loadUserProfile();
                        } else if (event === 'SIGNED_OUT') {
                            currentUser = null;
                            userProfile = null;
                            userType = null;
                            updateAuthUI();
                            hideAllSections();
                        }
                    } catch (error) {
                        console.error('Auth state change error:', error);
                    }
                });
            } catch (error) {
                console.error('初始化失败:', error);
                showMessage('初始化失败，请检查配置', 'error');
            }
        }

        function setupEventListeners() {
            try {
                // Check if elements exist before adding listeners
                const loginBtn = document.getElementById('login-btn');
                const registerBtn = document.getElementById('register-btn');
                const logoutBtn = document.getElementById('logout-btn');
                const profileBtn = document.getElementById('profile-btn');
                const saveProfileBtn = document.getElementById('save-profile-btn');
                const passengerTypeBtn = document.getElementById('passenger-type-btn');
                const driverTypeBtn = document.getElementById('driver-type-btn');
                const addPassengerRequestBtn = document.getElementById('add-passenger-request');
                const searchDriversBtn = document.getElementById('search-drivers');
                const addDriverScheduleBtn = document.getElementById('add-driver-schedule');

                // Auth events
                if (loginBtn) loginBtn.addEventListener('click', handleLogin);
                if (registerBtn) registerBtn.addEventListener('click', handleRegister);
                if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
                if (profileBtn) profileBtn.addEventListener('click', () => showSection('profile'));
                if (saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfile);
                
                // User type selection
                if (passengerTypeBtn) passengerTypeBtn.addEventListener('click', () => setUserType('passenger'));
                if (driverTypeBtn) driverTypeBtn.addEventListener('click', () => setUserType('driver'));

                // Passenger events
                if (addPassengerRequestBtn) addPassengerRequestBtn.addEventListener('click', addPassengerRequest);
                if (searchDriversBtn) searchDriversBtn.addEventListener('click', searchDrivers);

                // Driver events
                if (addDriverScheduleBtn) addDriverScheduleBtn.addEventListener('click', addDriverSchedule);

            } catch (error) {
                console.error('Event listener setup error:', error);
            }
        }

        async function checkAuthState() {
            if (!supabaseClient) return;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    updateAuthUI();
                    await loadUserData();
                }
            } catch (error) {
                console.error('Check auth state error:', error);
            }
        }

        async function handleLogin() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            if (!emailInput || !passwordInput) {
                showMessage('表单元素未找到', 'error');
                return;
            }

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                showMessage('请输入邮箱和密码', 'error');
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            if (loginBtn) {
                loginBtn.textContent = '登录中...';
                loginBtn.disabled = true;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;
                showMessage('登录成功！', 'success');
                clearAuthForm();
            } catch (error) {
                console.error('Login error:', error);
                showMessage('登录失败: ' + error.message, 'error');
            } finally {
                if (loginBtn) {
                    loginBtn.textContent = '登录';
                    loginBtn.disabled = false;
                }
            }
        }

        async function handleRegister() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            
            if (!emailInput || !passwordInput) {
                showMessage('表单元素未找到', 'error');
                return;
            }

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                showMessage('请输入邮箱和密码', 'error');
                return;
            }

            if (password.length < 6) {
                showMessage('密码长度至少需要6位', 'error');
                return;
            }

            const registerBtn = document.getElementById('register-btn');
            if (registerBtn) {
                registerBtn.textContent = '注册中...';
                registerBtn.disabled = true;
            }

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });

                if (error) throw error;
                
                if (data.user && !data.session) {
                    showMessage('注册成功！请检查邮箱并点击确认链接后再登录', 'success');
                } else {
                    showMessage('注册成功！', 'success');
                }
                clearAuthForm();
            } catch (error) {
                console.error('Register error:', error);
                showMessage('注册失败: ' + error.message, 'error');
            } finally {
                if (registerBtn) {
                    registerBtn.textContent = '注册';
                    registerBtn.disabled = false;
                }
            }
        }

        async function handleLogout() {
            try {
                await supabaseClient.auth.signOut();
                currentUser = null;
                userProfile = null;
                userType = null;
                updateAuthUI();
                hideAllSections();
                showMessage('已退出登录', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showMessage('退出失败', 'error');
            }
        }

        function updateAuthUI() {
            const userStatus = document.getElementById('user-status');
            const userId = document.getElementById('user-id');
            const loginForm = document.getElementById('login-form');
            const logoutBtn = document.getElementById('logout-btn');
            const profileBtn = document.getElementById('profile-btn');
            const userTypeSection = document.getElementById('user-type-section');

            if (currentUser) {
                if (userStatus) userStatus.textContent = `已登录: ${currentUser.email}`;
                if (userId) {
                    userId.textContent = `ID: ${currentUser.id.substring(0, 8)}...`;
                    userId.classList.remove('hidden');
                }
                if (loginForm) loginForm.classList.add('hidden');
                if (logoutBtn) logoutBtn.classList.remove('hidden');
                if (profileBtn) profileBtn.classList.remove('hidden');
                if (userTypeSection) userTypeSection.classList.remove('hidden');
            } else {
                if (userStatus) userStatus.textContent = '未登录';
                if (userId) userId.classList.add('hidden');
                if (loginForm) loginForm.classList.remove('hidden');
                if (logoutBtn) logoutBtn.classList.add('hidden');
                if (profileBtn) profileBtn.classList.add('hidden');
                if (userTypeSection) userTypeSection.classList.add('hidden');
            }
        }

        function setUserType(type) {
            userType = type;
            showSection(type);
            loadUserData();
        }

        function showSection(sectionName) {
            hideAllSections();
            const section = document.getElementById(sectionName + '-section');
            if (section) {
                section.classList.remove('hidden');
                section.classList.add('fade-in');
            }
        }

        function hideAllSections() {
            ['passenger-section', 'driver-section', 'profile-section'].forEach(id => {
                const section = document.getElementById(id);
                if (section) {
                    section.classList.add('hidden');
                }
            });
        }

        async function saveProfile() {
            if (!currentUser) {
                showMessage('请先登录', 'error');
                return;
            }

            const nameInput = document.getElementById('profile-name');
            const phoneInput = document.getElementById('profile-phone');
            const idNumberInput = document.getElementById('profile-id-number');
            const genderInput = document.getElementById('profile-gender');
            const ageInput = document.getElementById('profile-age');
            const bioInput = document.getElementById('profile-bio');

            if (!nameInput || !phoneInput || !idNumberInput || !genderInput || !ageInput || !bioInput) {
                showMessage('表单元素未找到', 'error');
                return;
            }

            const name = nameInput.value.trim();
            const phone = phoneInput.value.trim();
            const idNumber = idNumberInput.value.trim();
            const gender = genderInput.value;
            const age = ageInput.value;
            const bio = bioInput.value.trim();

            if (!name || !phone || !idNumber) {
                showMessage('请填写姓名、手机号和身份证号', 'error');
                return;
            }

            const saveBtn = document.getElementById('save-profile-btn');
            if (saveBtn) {
                saveBtn.textContent = '保存中...';
                saveBtn.disabled = true;
            }

            try {
                const profileData = {
                    user_id: currentUser.id,
                    full_name: name,
                    phone: phone,
                    id_number: idNumber,
                    gender: gender || null,
                    age: age ? parseInt(age) : null,
                    bio: bio || null,
                    updated_at: new Date().toISOString()
                };

                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .upsert(profileData)
                    .select()
                    .single();

                if (error) throw error;

                userProfile = data;
                showMessage('个人资料保存成功', 'success');
            } catch (error) {
                console.error('Save profile error:', error);
                showMessage('保存失败: ' + error.message, 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.textContent = '保存资料';
                    saveBtn.disabled = false;
                }
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;

            try {
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error;

                userProfile = data;
                
                if (userProfile) {
                    // 填充表单
                    const nameInput = document.getElementById('profile-name');
                    const phoneInput = document.getElementById('profile-phone');
                    const idNumberInput = document.getElementById('profile-id-number');
                    const genderInput = document.getElementById('profile-gender');
                    const ageInput = document.getElementById('profile-age');
                    const bioInput = document.getElementById('profile-bio');

                    if (nameInput) nameInput.value = userProfile.full_name || '';
                    if (phoneInput) phoneInput.value = userProfile.phone || '';
                    if (idNumberInput) idNumberInput.value = userProfile.id_number || '';
                    if (genderInput) genderInput.value = userProfile.gender || '';
                    if (ageInput) ageInput.value = userProfile.age || '';
                    if (bioInput) bioInput.value = userProfile.bio || '';
                }
            } catch (error) {
                console.error('加载个人资料失败:', error);
            }
        }

        async function addPassengerRequest() {
            if (!currentUser) {
                showMessage('请先登录', 'error');
                return;
            }

            const fromCityInput = document.getElementById('passenger-from');
            const toCityInput = document.getElementById('passenger-to');
            const dateInput = document.getElementById('passenger-date');
            const timeInput = document.getElementById('passenger-time');
            const seatsInput = document.getElementById('passenger-seats');
            const noteInput = document.getElementById('passenger-note');

            if (!fromCityInput || !toCityInput || !dateInput || !timeInput || !seatsInput || !noteInput) {
                showMessage('表单元素未找到', 'error');
                return;
            }

            const fromCity = fromCityInput.value.trim();
            const toCity = toCityInput.value.trim();
            const date = dateInput.value;
            const time = timeInput.value;
            const seats = seatsInput.value;
            const note = noteInput.value.trim();

            if (!fromCity || !toCity || !date || !time || !seats) {
                showMessage('请填写完整信息', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('passenger_requests')
                    .insert({
                        user_id: currentUser.id,
                        from_city: fromCity,
                        to_city: toCity,
                        date: date,
                        time: time,
                        seats_needed: parseInt(seats),
                        note: note
                    });

                if (error) throw error;

                showMessage('需求发布成功', 'success');
                clearPassengerForm();
                loadPassengerRequests();
            } catch (error) {
                console.error('Add passenger request error:', error);
                showMessage('发布失败: ' + error.message, 'error');
            }
        }

        async function addDriverSchedule() {
            if (!currentUser) {
                showMessage('请先登录', 'error');
                return;
            }

            const fromCityInput = document.getElementById('driver-from');
            const toCityInput = document.getElementById('driver-to');
            const dateInput = document.getElementById('driver-date');
            const timeInput = document.getElementById('driver-time');
            const seatsInput = document.getElementById('driver-seats');
            const priceInput = document.getElementById('driver-price');
            const noteInput = document.getElementById('driver-note');

            if (!fromCityInput || !toCityInput || !dateInput || !timeInput || !seatsInput || !priceInput || !noteInput) {
                showMessage('表单元素未找到', 'error');
                return;
            }

            const fromCity = fromCityInput.value.trim();
            const toCity = toCityInput.value.trim();
            const date = dateInput.value;
            const time = timeInput.value;
            const seats = seatsInput.value;
            const price = priceInput.value;
            const note = noteInput.value.trim();

            if (!fromCity || !toCity || !date || !time || !seats) {
                showMessage('请填写完整信息', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('driver_schedules')
                    .insert({
                        user_id: currentUser.id,
                        from_city: fromCity,
                        to_city: toCity,
                        date: date,
                        time: time,
                        available_seats: parseInt(seats),
                        price_per_person: parseFloat(price) || 0,
                        note: note
                    });

                if (error) throw error;

                showMessage('时间表发布成功', 'success');
                clearDriverForm();
                loadDriverSchedules();
            } catch (error) {
                console.error('Add driver schedule error:', error);
                showMessage('发布失败: ' + error.message, 'error');
            }
        }

        async function searchDrivers() {
            const searchFromInput = document.getElementById('search-from');
            const searchToInput =
