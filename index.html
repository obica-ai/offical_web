<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>城际同行平台 · 乘客&司机（云端版）</title>
  <meta name="description" content="两类用户（乘客/司机）使用同一平台：乘客发布需求，司机发布空闲班次。使用 Supabase（Postgres+Auth+RLS）作为后端数据库。" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .fade-in { animation: fadeIn .5s ease both; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
    input, select, textarea{ border-radius: 0.75rem; border:1px solid #cbd5e1; padding: .5rem .75rem; outline: none; }
    input:focus, select:focus, textarea:focus{ box-shadow: 0 0 0 2px #000; }
    label{ font-size: .9rem; font-weight: 600; }
  </style>
</head>
<body class="antialiased text-slate-800 bg-slate-50 min-h-screen">
  <header class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 items-center justify-between">
        <div class="inline-flex items-center gap-2 font-semibold">
          <span class="inline-block h-8 w-8 rounded-2xl bg-black"></span>
          <span>城际同行</span>
        </div>
        <nav class="hidden md:flex items-center gap-6 text-sm">
          <a href="#passenger" class="hover:text-black">乘客</a>
          <a href="#driver" class="hover:text-black">司机</a>
          <a href="#how" class="hover:text-black">使用说明</a>
        </nav>
      </div>
    </div>
  </header>

<!-- 角色/资料设置对话框 -->
<dialog id="roleDialog" class="rounded-2xl p-0 w-[min(560px,92vw)]">
  <form method="dialog" class="rounded-2xl bg-white border border-slate-200 shadow-lg overflow-hidden">
    <div class="px-6 py-4 border-b flex items-center justify-between">
      <h4 class="font-semibold">完善资料 · 选择你的角色</h4>
      <button class="px-2 py-1" value="close" aria-label="关闭">✕</button>
    </div>
    <div class="p-6 grid sm:grid-cols-2 gap-4">
      <div class="sm:col-span-2 text-sm text-slate-600">请选择你在平台中的身份（可选“同时”）：</div>
      <div class="sm:col-span-2 flex gap-4 items-center text-sm">
        <label class="inline-flex items-center gap-2"><input type="radio" name="role" value="passenger"> 乘客</label>
        <label class="inline-flex items-center gap-2"><input type="radio" name="role" value="driver"> 司机</label>
        <label class="inline-flex items-center gap-2"><input type="radio" name="role" value="both" checked> 同时</label>
      </div>
      <div>
        <label>显示名称（给对方看到）</label>
        <input id="prof_name" placeholder="例如：王师傅 / Lena" />
      </div>
      <div>
        <label>联系方式（仅在撮合后可见）</label>
        <input id="prof_phone" placeholder="手机号或微信号" />
      </div>
    </div>
    <div class="px-6 py-4 border-t flex items-center justify-end gap-3 bg-slate-50">
      <button class="rounded-xl border border-slate-300 px-4 py-2 text-sm" value="cancel">稍后</button>
      <button id="btnSaveProfile" class="rounded-xl bg-black text-white px-4 py-2 text-sm font-semibold" value="default">保存</button>
    </div>
  </form>
</dialog>

<!-- 配置状态提示 -->
<div id="statusBar" class="hidden bg-amber-50 border-b border-amber-200 text-amber-800 text-sm">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-2">
    未检测到有效的 Supabase 配置。请设置 <code>window.SUPABASE_URL</code> 与 <code>window.SUPABASE_ANON_KEY</code>，或在地址栏追加 <code>?sbUrl=...&sbKey=...</code>。
  </div>
</div>

  <main class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
  <!-- Auth -->
  <section class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm mb-8">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div>
        <h2 class="text-lg font-bold">登录 / 注册</h2>
        <p class="text-sm text-slate-600">使用邮箱一键登录（Magic Link）。登录后可发布与管理你的数据。</p>
      </div>
      <div class="flex items-center gap-2">
        <span id="authStatus" class="text-sm text-slate-600">未登录</span>
        <span id="roleBadge" class="hidden inline-flex items-center text-xs rounded-full bg-slate-100 border border-slate-200 px-2 py-0.5"></span>
        <button id="btnEditProfile" class="hidden rounded-xl border border-slate-300 px-3 py-1.5 text-sm">资料/角色</button>
        <button id="btnSignOut" class="hidden rounded-xl border border-slate-300 px-3 py-1.5 text-sm">退出</button>" class="hidden rounded-xl border border-slate-300 px-3 py-1.5 text-sm">退出</button>
      </div>
    </div>
    <div id="authBox" class="mt-4 grid sm:grid-cols-[1fr_auto] gap-2">
      <input id="authEmail" type="email" placeholder="you@example.com" />
      <button id="btnMagic" class="rounded-xl bg-black text-white px-4 py-2 text-sm font-semibold">发送登录链接</button>
    </div>
    <p class="text-xs text-slate-500 mt-2">* 第一次登录会自动创建账号；邮箱里点击 Magic Link 即可返回本页登录。</p>
  </section>

  <div class="grid lg:grid-cols-3 gap-8">
    <!-- 左：乘客需求 -->
    <section class="lg:col-span-2 space-y-8">
      <div id="passenger" class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm fade-in">
        <h2 class="text-xl font-bold">乘客 · 发布需求 & 搜索司机</h2>
        <p class="mt-1 text-sm text-slate-600">发布你的出行需求（出发/到达/日期/座位），也可按条件搜索司机空闲班次。</p>

        <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label>出发城市</label>
            <input id="need_from" placeholder="上海" />
          </div>
          <div>
            <label>到达城市</label>
            <input id="need_to" placeholder="杭州" />
          </div>
          <div>
            <label>日期</label>
            <input id="need_date" type="date" />
          </div>
          <div>
            <label>需要座位</label>
            <input id="need_seats" type="number" min="1" value="1" />
          </div>
          <div class="lg:col-span-4">
            <label>备注</label>
            <input id="need_note" placeholder="行李/上车点/时间弹性等" />
          </div>
          <div class="sm:col-span-2 lg:col-span-4 flex items-end justify-end gap-2">
            <button id="btnAddNeed" class="rounded-xl bg-black text-white px-4 py-2 text-sm font-semibold">+ 发布需求</button>
            <button id="btnSearchSlots" class="rounded-xl border border-slate-300 px-4 py-2 text-sm">按条件搜索司机班次</button>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold">符合条件的司机班次</h3>
          <div id="slotResults" class="mt-3 grid gap-3"></div>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold">我发布的乘客需求</h3>
          <div id="myNeeds" class="mt-3 grid gap-3"></div>
        </div>
      </div>

      <!-- 司机面板 -->
      <div id="driver" class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm fade-in">
        <h2 class="text-xl font-bold">司机 · 发布空闲班次</h2>
        <p class="mt-1 text-sm text-slate-600">填写你的行程（出发/到达/日期/时间/座位/备注），供乘客搜索预约。</p>

        <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-6 gap-4">
          <div>
            <label>出发城市</label>
            <input id="slot_from" placeholder="上海" />
          </div>
          <div>
            <label>到达城市</label>
            <input id="slot_to" placeholder="杭州" />
          </div>
          <div>
            <label>日期</label>
            <input id="slot_date" type="date" />
          </div>
          <div>
            <label>时间</label>
            <input id="slot_time" type="time" />
          </div>
          <div>
            <label>可用座位</label>
            <input id="slot_seats" type="number" min="1" value="3" />
          </div>
          <div>
            <label>备注</label>
            <input id="slot_note" placeholder="上门接/中途站点等" />
          </div>
          <div class="sm:col-span-2 lg:col-span-6 flex items-end justify-end">
            <button id="btnAddSlot" class="rounded-xl bg-black text-white px-4 py-2 text-sm font-semibold">+ 发布空闲班次</button>
          </div>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold">我发布的司机班次</h3>
          <div id="mySlots" class="mt-3 grid gap-3"></div>
        </div>
      </div>
    </section>

    <!-- 右：说明/状态 -->
    <aside class="space-y-4">
      <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm">
        <h3 class="font-semibold">后端：Supabase</h3>
        <ul class="mt-2 text-sm text-slate-600 list-disc list-inside space-y-1">
          <li>Auth：邮箱 Magic Link</li>
          <li>DB：Postgres（RLS 行级权限）</li>
          <li>前端：supabase-js v2 直接调用</li>
        </ul>
      </div>
      <div class="rounded-2xl bg-white border border-slate-200 p-6 shadow-sm text-sm text-slate-600">
        <p class="mb-2 font-semibold">环境变量（请替换）</p>
        <code id="envPreview" class="text-xs break-all">SUPABASE_URL=（你的项目URL）
SUPABASE_ANON_KEY=（你的匿名Key）</code>
      </div>
    </aside>
  </div>
</main>

<footer class="border-t border-slate-200">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 text-sm text-slate-600 flex flex-col sm:flex-row items-center justify-between gap-4">
    <p>© <span id="year"></span> 城际同行</p>
    <div class="flex items-center gap-4">
      <a class="hover:text-black" href="#">隐私政策（示例）</a>
      <a class="hover:text-black" href="#">使用条款（示例）</a>
    </div>
  </div>
</footer> class="border-t border-slate-200">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8 text-sm text-slate-600 flex flex-col sm:flex-row items-center justify-between gap-4">
      <p>© <span id="year"></span> 城际同行</p>
      <div class="flex items-center gap-4">
        <a class="hover:text-black" href="#">隐私政策（示例）</a>
        <a class="hover:text-black" href="#">使用条款（示例）</a>
      </div>
    </div>
  </footer>

  <template id="tplCard">
  <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
    <div class="text-sm flex items-center justify-between gap-3">
      <div>
        <div class="font-semibold"><span data-from></span> → <span data-to></span> · <span data-date></span> <span data-time></span></div>
        <div class="text-slate-600 mt-1">座位：<span data-seats></span> · <span data-note></span></div>
      </div>
      <div class="flex items-center gap-2">
        <button data-del class="hidden rounded-lg border border-slate-300 px-2 py-1 text-xs">删除</button>
      </div>
    </div>
  </div>
</template>

<script>
// ======= Supabase 初始化 =======
// 支持通过 URL 参数快速注入：?sbUrl=...&sbKey=...
(function injectEnvFromQuery(){
  try{
    const usp = new URLSearchParams(location.search);
    const u = usp.get('sbUrl'); const k = usp.get('sbKey');
    if(u && k){ window.SUPABASE_URL = u; window.SUPABASE_ANON_KEY = k; }
  }catch(e){}
})();

const SUPABASE_URL = window.SUPABASE_URL || 'https://ddycdlhhgezffmybssvw.supabase.co'; // ← 替换
const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkeWNkbGhoZ2V6ZmZteWJzc3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NDA4MzAsImV4cCI6MjA3MjExNjgzMH0.JAU94T7uUZQCvuXtaZbMc3VXTAKQyprTX0H62AGOtyo'; // ← 替换
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// 年份与环境预览
document.getElementById('year').textContent = new Date().getFullYear();
document.getElementById('envPreview').textContent = `SUPABASE_URL=${SUPABASE_URL}
SUPABASE_ANON_KEY=${(SUPABASE_ANON_KEY||'').slice(0,8)}...`;

// 配置检测
(function(){
  const bad = !SUPABASE_URL || SUPABASE_URL.includes('YOUR-PROJECT') || !/^https?:\/\//.test(SUPABASE_URL) || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY==='YOUR-ANON-KEY';
  if(bad){ document.getElementById('statusBar').classList.remove('hidden'); }
})();

// 元素引用
const el = (id)=>document.getElementById(id);
const ui = {
  authStatus: el('authStatus'), authBox: el('authBox'), btnSignOut: el('btnSignOut'), btnMagic: el('btnMagic'), authEmail: el('authEmail'),
  roleBadge: el('roleBadge'), btnEditProfile: el('btnEditProfile'), roleDialog: document.getElementById('roleDialog'), btnSaveProfile: document.getElementById('btnSaveProfile'),
  prof_name: el('prof_name'), prof_phone: el('prof_phone'),
  // passenger need
  need_from: el('need_from'), need_to: el('need_to'), need_date: el('need_date'), need_seats: el('need_seats'), need_note: el('need_note'),
  btnAddNeed: el('btnAddNeed'), myNeeds: el('myNeeds'), btnSearchSlots: el('btnSearchSlots'), slotResults: el('slotResults'),
  // driver slots
  slot_from: el('slot_from'), slot_to: el('slot_to'), slot_date: el('slot_date'), slot_time: el('slot_time'), slot_seats: el('slot_seats'), slot_note: el('slot_note'),
  btnAddSlot: el('btnAddSlot'), mySlots: el('mySlots'),
  tplCard: document.getElementById('tplCard'),
};

// 简易状态
let currentUser = null;
let currentProfile = null; // { id, role, full_name, phone }

function requireLogin(){ if(currentUser){ alert('请先登录 / 注册'); return false;} return true; }

// 登录：Magic Link
ui.btnMagic.addEventListener('click', async ()=>{
  const email = ui.authEmail.value.trim();
  if(!email) return alert('请输入邮箱');
  const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href }});
  if(error) return alert('发送失败：'+error.message);
  alert('已发送登录链接到邮箱，请查收并点击登录。');
});

ui.btnSignOut.addEventListener('click', async ()=>{
  await sb.auth.signOut();
});

sb.auth.onAuthStateChange(async (_event, session) => {
  currentUser = session?.user || null;
  ui.authStatus.textContent = currentUser ? `已登录：${currentUser.email}` : '未登录';
  const authed = !!currentUser;
  ui.btnSignOut.classList.toggle('hidden', !authed);
  ui.btnEditProfile.classList.toggle('hidden', !authed);
  ui.authBox.classList.toggle('hidden', authed);
  if(currentUser){ await loadProfile(); loadMyNeeds(); loadMySlots(); }
});
  ui.authBox.classList.toggle('hidden', !!currentUser);
  if(currentUser){ loadMyNeeds(); loadMySlots(); }
});

// ======= 乘客需求 CRUD =======
async function loadMyNeeds(){
  const { data, error } = await sb.from('passenger_needs').select('*').order('created_at', { ascending:false });
  if(error) return console.error(error);
  renderList(ui.myNeeds, data, true, async (id)=>{
    await sb.from('passenger_needs').delete().eq('id', id); loadMyNeeds();
  });
}

ui.btnAddNeed.addEventListener('click', async ()=>{
  if(!requireLogin()) return;
  const row = {
    from_city: ui.need_from.value.trim(),
    to_city: ui.need_to.value.trim(),
    date: ui.need_date.value,
    seats: parseInt(ui.need_seats.value||'1',10),
    note: ui.need_note.value.trim(),
  };
  if(!row.from_city || !row.to_city || !row.date || !row.seats) return alert('请完整填写需求');
  const { error } = await sb.from('passenger_needs').insert(row);
  if(error) return alert('发布失败：'+error.message);
  ui.need_note.value='';
  await loadMyNeeds();
});

ui.btnSearchSlots.addEventListener('click', async ()=>{
  const from = ui.need_from.value.trim();
  const to = ui.need_to.value.trim();
  const date = ui.need_date.value;
  const seats = parseInt(ui.need_seats.value||'1',10);
  let query = sb.from('driver_slots').select('*').gte('seats', seats);
  if(from) query = query.ilike('from_city', `%${from}%`);
  if(to) query = query.ilike('to_city', `%${to}%`);
  if(date) query = query.eq('date', date);
  const { data, error } = await query.order('date').order('time');
  if(error) return alert('搜索失败：'+error.message);
  renderList(ui.slotResults, data, false);
});

// ======= 司机空闲班次 CRUD =======
async function loadMySlots(){
  const { data, error } = await sb.from('driver_slots').select('*').order('date').order('time');
  if(error) return console.error(error);
  renderList(ui.mySlots, data, true, async (id)=>{
    await sb.from('driver_slots').delete().eq('id', id); loadMySlots();
  });
}

ui.btnAddSlot.addEventListener('click', async ()=>{
  if(!requireLogin()) return;
  const row = {
    from_city: ui.slot_from.value.trim(),
    to_city: ui.slot_to.value.trim(),
    date: ui.slot_date.value,
    time: ui.slot_time.value,
    seats: parseInt(ui.slot_seats.value||'1',10),
    note: ui.slot_note.value.trim(),
  };
  if(!row.from_city || !row.to_city || !row.date || !row.time || !row.seats) return alert('请完整填写班次');
  const { error } = await sb.from('driver_slots').insert(row);
  if(error) return alert('发布失败：'+error.message);
  ui.slot_note.value='';
  await loadMySlots();
});

// ======= 通用渲染 =======
function renderList(container, rows, mine=false, onDel){
  container.innerHTML='';
  if(!rows || rows.length===0){ container.innerHTML='<div class="text-sm text-slate-600">暂无数据</div>'; return; }
  rows.forEach(r=>{
    const node = ui.tplCard.content.firstElementChild.cloneNode(true);
    node.querySelector('[data-from]').textContent = r.from_city;
    node.querySelector('[data-to]').textContent = r.to_city;
    node.querySelector('[data-date]').textContent = r.date || '';
    node.querySelector('[data-time]').textContent = r.time || '';
    node.querySelector('[data-seats]').textContent = r.seats ?? '-';
    node.querySelector('[data-note]').textContent = r.note || '';
    if(mine){
      const btnDel = node.querySelector('[data-del]');
      btnDel.classList.remove('hidden');
      btnDel.addEventListener('click', ()=> onDel && onDel(r.id));
    }
    container.appendChild(node);
  });
}

// 资料加载与保存
async function loadProfile(){
  const { data, error } = await sb.from('profiles').select('*').maybeSingle();
  if(error && error.code!=='PGRST116'){ console.error(error); return; } // PGRST116 = no rows
  currentProfile = data || null;
  // 展示徽章
  const role = currentProfile?.role || 'both';
  ui.roleBadge.textContent = `角色：${role}`;
  ui.roleBadge.classList.toggle('hidden', !currentUser);
  // 若无资料，弹窗引导
  if(!currentProfile){ ui.roleDialog.showModal(); }
  // 预填
  ui.prof_name.value = currentProfile?.full_name || '';
  ui.prof_phone.value = currentProfile?.phone || '';
  // 根据角色调整首屏（可选：滚动到对应区域）
}

ui.btnEditProfile.addEventListener('click', ()=> ui.roleDialog.showModal());

ui.btnSaveProfile.addEventListener('click', async (e)=>{
  e.preventDefault();
  if(!requireLogin()) return;
  const role = (document.querySelector('input[name="role"]:checked')||{}).value || 'both';
  const row = { role, full_name: ui.prof_name.value.trim()||null, phone: ui.prof_phone.value.trim()||null };
  const { data, error } = await sb.from('profiles').upsert(row).select().single();
  if(error){ alert('保存失败：'+error.message); return; }
  currentProfile = data;
  ui.roleBadge.textContent = `角色：${data.role}`;
  ui.roleDialog.close();
});

// 初始化会话恢复
(async ()=>{
  const { data:{ session } } = await sb.auth.getSession();
  currentUser = session?.user || null;
  ui.authStatus.textContent = currentUser ? `已登录：${currentUser.email}` : '未登录';
  const authed = !!currentUser;
  ui.btnSignOut.classList.toggle('hidden', !authed);
  ui.btnEditProfile.classList.toggle('hidden', !authed);
  ui.authBox.classList.toggle('hidden', authed);
  if(currentUser){ await loadProfile(); loadMyNeeds(); loadMySlots(); }
})();
</script>
</body>
</html>
