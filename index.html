<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>城际同行 · 北美地址版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    .fade-in{animation:fadeIn .25s ease-in both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- 顶部栏 -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-blue-600"></div>
        <h1 class="text-lg font-semibold">城际同行</h1>
      </div>
      <nav class="flex items-center gap-2 text-sm">
        <button id="nav-board" class="px-3 py-1.5 rounded-md hover:bg-gray-100">公告栏</button>
        <button id="nav-passenger" class="px-3 py-1.5 rounded-md hover:bg-gray-100">乘客</button>
        <button id="nav-driver" class="px-3 py-1.5 rounded-md hover:bg-gray-100">司机</button>
      </nav>
    </div>
  </header>

  <!-- 环境状态条 -->
  <div id="statusBar" class="hidden bg-amber-50 border-b border-amber-200 text-amber-800 text-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2">
      未检测到 Supabase 配置。设置 <code>window.SUPABASE_URL</code>/<code>window.SUPABASE_ANON_KEY</code> 或在地址栏追加 <code>?sbUrl=...&sbKey=...</code>。
    </div>
  </div>

  <!-- 通知条 -->
  <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 z-50 hidden"></div>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <!-- Auth -->
    <section class="bg-white rounded-xl border shadow-sm p-6">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-base font-semibold">用户登录</h2>
          <p class="text-gray-500 text-sm">邮箱+密码，或发送登录链接（Magic Link）</p>
        </div>
        <div class="flex items-center gap-3">
          <span id="authStatus" class="text-sm text-gray-600">未登录</span>
          <button id="btnEditProfile" class="hidden px-3 py-1.5 rounded-md border text-sm">资料</button>
          <button id="btnSignOut" class="hidden px-3 py-1.5 rounded-md border text-sm">退出</button>
        </div>
      </div>
      <div id="authBox" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="authEmail" type="email" placeholder="邮箱" class="px-3 py-2 border rounded-md">
        <input id="authPass" type="password" placeholder="密码（≥6位）" class="px-3 py-2 border rounded-md">
        <div class="flex gap-2">
          <button id="btnLogin" class="px-4 py-2 rounded-md bg-blue-600 text-white">登录</button>
          <button id="btnRegister" class="px-4 py-2 rounded-md bg-green-600 text-white">注册</button>
          <button id="btnMagic" class="px-4 py-2 rounded-md border">发登录链接</button>
        </div>
      </div>
    </section>

    <!-- 公告栏（新增） -->
    <section id="board-section" class="hidden bg-white rounded-xl border shadow-sm p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">公告栏</h3>
        <div class="flex items-center gap-2">
          <input id="board-filter" class="px-3 py-2 border rounded-md text-sm" placeholder="按城市 / 州 / 邮编筛选（出发或目的地）">
          <button id="btnBoardRefresh" class="px-3 py-2 rounded-md border text-sm">刷新</button>
        </div>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">司机可用（最近 20 条）</h4>
            <span id="driver-count" class="text-xs text-gray-500">0 条</span>
          </div>
          <div id="driver-board" class="space-y-3"></div>
        </div>
        <div>
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">乘客需求（最近 20 条）</h4>
            <span id="passenger-count" class="text-xs text-gray-500">0 条</span>
          </div>
          <div id="passenger-board" class="space-y-3"></div>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-4">提示：已开启 Realtime 时，公告栏会自动更新；否则可点“刷新”。</p>
    </section>

    <!-- 个人资料 -->
    <section id="profile-section" class="hidden bg-white rounded-xl border shadow-sm p-6">
      <h3 class="text-lg font-semibold mb-4">个人资料</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="profile-name" type="text" placeholder="姓名" class="px-3 py-2 border rounded-md">
        <input id="profile-phone" type="tel" placeholder="手机号" class="px-3 py-2 border rounded-md">
        <input id="profile-id-number" type="text" placeholder="身份证/驾照号" class="px-3 py-2 border rounded-md">
        <select id="profile-gender" class="px-3 py-2 border rounded-md">
          <option value="">性别</option><option value="male">男</option><option value="female">女</option>
        </select>
        <input id="profile-age" type="number" min="18" max="100" placeholder="年龄" class="px-3 py-2 border rounded-md">
        <input id="profile-bio" type="text" placeholder="简介（可选）" class="px-3 py-2 border rounded-md">
      </div>
      <div class="mt-4">
        <button id="btnSaveProfile" class="px-4 py-2 rounded-md bg-blue-600 text-white">保存资料</button>
      </div>
    </section>

    <!-- 乘客 -->
    <section id="passenger-section" class="hidden">
      <!-- 可用司机列表（乘客可见） -->
        <div class="mt-6">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">可用司机</h4>
            <div class="flex items-center gap-2">
              <input id="driver-filter" class="px-3 py-2 border rounded-md text-sm" placeholder="按城市 / 州 / 邮编筛选">
              <button id="btnDriversRefresh" class="px-3 py-2 rounded-md border text-sm">刷新</button>
            </div>
          </div>
          <div id="driver-list" class="space-y-3"></div>
        </div>
      <div class="bg-white rounded-xl border shadow-sm p-6">
        <h2 class="text-lg font-semibold mb-4">乘客 - 发布行程需求</h2>

        <!-- 出发地址 -->
        <h4 class="text-sm font-semibold text-gray-700 mb-2">出发地址</h4>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">Country</label>
            <select id="passenger-origin-country" class="w-full px-3 py-2 border rounded-md">
              <option value="US" selected>United States</option>
              <option value="CA">Canada</option>
            </select>
          </div>
          <div class="md:col-span-4">
            <label class="block text-xs text-gray-500">Street address</label>
            <input id="passenger-origin-street1" placeholder="123 Main St" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">Apt / Unit（可选）</label>
            <input id="passenger-origin-street2" placeholder="Apt 5B" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">City</label>
            <input id="passenger-origin-city" placeholder="San Francisco" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs text-gray-500">State/Prov.</label>
            <input id="passenger-origin-state" list="na-states" placeholder="CA" class="w-full px-3 py-2 border rounded-md uppercase">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs text-gray-500">ZIP/Postal</label>
            <input id="passenger-origin-postal" placeholder="94105 或 M5V 2T6" class="w-full px-3 py-2 border rounded-md uppercase">
          </div>
        </div>

        <!-- 目的地地址 -->
        <h4 class="text-sm font-semibold text-gray-700 mt-4 mb-2">目的地地址</h4>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">Country</label>
            <select id="passenger-dest-country" class="w-full px-3 py-2 border rounded-md">
              <option value="US" selected>United States</option>
              <option value="CA">Canada</option>
            </select>
          </div>
          <div class="md:col-span-4">
            <label class="block text-xs text-gray-500">Street address</label>
            <input id="passenger-dest-street1" placeholder="456 King St W" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">Apt / Unit（可选）</label>
            <input id="passenger-dest-street2" placeholder="Suite 210" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">City</label>
            <input id="passenger-dest-city" placeholder="Toronto" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs text-gray-500">State/Prov.</label>
            <input id="passenger-dest-state" list="na-states" placeholder="ON" class="w-full px-3 py-2 border rounded-md uppercase">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs text-gray-500">ZIP/Postal</label>
            <input id="passenger-dest-postal" placeholder="10001 或 H3Z 2Y7" class="w-full px-3 py-2 border rounded-md uppercase">
          </div>
        </div>

        <!-- 其它字段 -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-4">
          <input id="passenger-date" type="date" class="px-3 py-2 border rounded-md">
          <input id="passenger-time" type="time" class="px-3 py-2 border rounded-md">
          <input id="passenger-seats" type="number" min="1" max="8" placeholder="需要座位数" class="px-3 py-2 border rounded-md">
          <input id="passenger-note" placeholder="备注（可选）" class="px-3 py-2 border rounded-md md:col-span-1">
        </div>

        <div class="mt-4">
          <button id="add-passenger-request" class="px-5 py-2 rounded-md bg-blue-600 text-white">发布需求</button>
        </div>
      </div>
    </section>

    <!-- 司机 -->
    <section id="driver-section" class="hidden">
      <!-- 乘客需求列表（司机可见） -->
        <div class="mt-6">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">乘客需求</h4>
            <div class="flex items-center gap-2">
              <input id="passenger-filter" class="px-3 py-2 border rounded-md text-sm" placeholder="按城市 / 州 / 邮编筛选">
              <button id="btnPassengersRefresh" class="px-3 py-2 rounded-md border text-sm">刷新</button>
            </div>
          </div>
          <div id="passenger-list" class="space-y-3"></div>
        </div>
      <div class="bg-white rounded-xl border shadow-sm p-6">
        <h2 class="text-lg font-semibold mb-4">司机 - 发布可用时间表</h2>

        <!-- 出发地址 -->
        <h4 class="text-sm font-semibold text-gray-700 mb-2">出发地址</h4>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">Country</label>
            <select id="driver-origin-country" class="w-full px-3 py-2 border rounded-md">
              <option value="US" selected>United States</option>
              <option value="CA">Canada</option>
            </select>
          </div>
          <div class="md:col-span-4">
            <label class="block text-xs text-gray-500">Street address</label>
            <input id="driver-origin-street1" placeholder="123 Main St" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">Apt / Unit（可选）</label>
            <input id="driver-origin-street2" placeholder="Apt 5B" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">City</label>
            <input id="driver-origin-city" placeholder="San Francisco" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs text-gray-500">State/Prov.</label>
            <input id="driver-origin-state" list="na-states" placeholder="CA" class="w-full px-3 py-2 border rounded-md uppercase">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs text-gray-500">ZIP/Postal</label>
            <input id="driver-origin-postal" placeholder="94105 或 M5V 2T6" class="w-full px-3 py-2 border rounded-md uppercase">
          </div>
        </div>

        <!-- 目的地地址 -->
        <h4 class="text-sm font-semibold text-gray-700 mt-4 mb-2">目的地地址</h4>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-3">
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">Country</label>
            <select id="driver-dest-country" class="w-full px-3 py-2 border rounded-md">
              <option value="US" selected>United States</option>
              <option value="CA">Canada</option>
            </select>
          </div>
          <div class="md:col-span-4">
            <label class="block text-xs text-gray-500">Street address</label>
            <input id="driver-dest-street1" placeholder="456 King St W" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">Apt / Unit（可选）</label>
            <input id="driver-dest-street2" placeholder="Suite 210" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-2">
            <label class="block text-xs text-gray-500">City</label>
            <input id="driver-dest-city" placeholder="Toronto" class="w-full px-3 py-2 border rounded-md">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs text-gray-500">State/Prov.</label>
            <input id="driver-dest-state" list="na-states" placeholder="ON" class="w-full px-3 py-2 border rounded-md uppercase">
          </div>
          <div class="md:col-span-1">
            <label class="block text-xs text-gray-500">ZIP/Postal</label>
            <input id="driver-dest-postal" placeholder="10001 或 H3Z 2Y7" class="w-full px-3 py-2 border rounded-md uppercase">
          </div>
        </div>

        <!-- 其它字段 -->
        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mt-4">
          <input id="driver-date" type="date" class="px-3 py-2 border rounded-md">
          <input id="driver-time" type="time" class="px-3 py-2 border rounded-md">
          <input id="driver-seats" type="number" min="1" max="8" placeholder="可载人数" class="px-3 py-2 border rounded-md">
          <input id="driver-price" type="number" min="0" step="0.01" placeholder="每人价格(元)" class="px-3 py-2 border rounded-md">
          <input id="driver-note" placeholder="备注（可选）" class="px-3 py-2 border rounded-md">
        </div>

        <div class="mt-4">
          <button id="add-driver-schedule" class="px-5 py-2 rounded-md bg-green-600 text-white">发布时间表</button>
        </div>
      </div>
    </section>
  </main>

  <!-- 北美州/省缩写（US + CA） -->
  <datalist id="na-states">
    <!-- US -->
    <option>AL</option><option>AK</option><option>AZ</option><option>AR</option><option>CA</option><option>CO</option><option>CT</option><option>DE</option><option>DC</option><option>FL</option><option>GA</option><option>HI</option><option>ID</option><option>IL</option><option>IN</option><option>IA</option><option>KS</option><option>KY</option><option>LA</option><option>ME</option><option>MD</option><option>MA</option><option>MI</option><option>MN</option><option>MS</option><option>MO</option><option>MT</option><option>NE</option><option>NV</option><option>NH</option><option>NJ</option><option>NM</option><option>NY</option><option>NC</option><option>ND</option><option>OH</option><option>OK</option><option>OR</option><option>PA</option><option>RI</option><option>SC</option><option>SD</option><option>TN</option><option>TX</option><option>UT</option><option>VT</option><option>VA</option><option>WA</option><option>WV</option><option>WI</option><option>WY</option>
    <!-- CA -->
    <option>AB</option><option>BC</option><option>MB</option><option>NB</option><option>NL</option><option>NS</option><option>NT</option><option>NU</option><option>ON</option><option>PE</option><option>QC</option><option>SK</option><option>YT</option>
  </datalist>

  <script>
    // —— 环境注入：支持 ?sbUrl=...&sbKey=... ——
    (function(){
      try{
        const usp = new URLSearchParams(location.search);
        const u = usp.get('sbUrl'); const k = usp.get('sbKey');
        if(u && k){ window.SUPABASE_URL = u; window.SUPABASE_ANON_KEY = k; }
      }catch(e){}
    })();

    const SUPABASE_URL = window.SUPABASE_URL || 'https://ddycdlhhgezffmybssvw.supabase.co';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkeWNkbGhoZ2V6ZmZteWJzc3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NDA4MzAsImV4cCI6MjA3MjExNjgzMH0.JAU94T7uUZQCvuXtaZbMc3VXTAKQyprTX0H62AGOtyo';

    if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR-PROJECT') || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY==='YOUR-ANON-KEY') {
      document.getElementById('statusBar').classList.remove('hidden');
    }

    // —— Supabase 初始化 ——
    const sb = (typeof supabase!=='undefined') ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    // —— UI 工具 ——
    function toast(msg, type='info'){
      const t = document.getElementById('toast');
      t.className = 'fixed top-20 left-1/2 -translate-x-1/2 z-50';
      t.innerHTML = '<div class="px-4 py-2 rounded-md shadow border '+(type==='error'?'bg-red-50 text-red-700 border-red-200':'bg-emerald-50 text-emerald-700 border-emerald-200')+'">'+msg+'</div>';
      t.classList.remove('hidden');
      setTimeout(()=>t.classList.add('hidden'), 3000);
    }
    function showSection(name){
      ['board','profile','passenger','driver'].forEach(s=>{
        const el=document.getElementById(s+'-section');
        if(el) el.classList.add('hidden');
      });
      const target=document.getElementById(name+'-section');
      if(target){ target.classList.remove('hidden'); target.classList.add('fade-in'); }
    }

    // —— 地址处理 ——
    function normalizePostal(country, v){
      if(!v) return null;
      v = v.toUpperCase().trim();
      if(country==='CA') return v.replace(/\s+/g,''); // 存储去空格
      return v;
    }
    function isValidPostal(country, v){
      if(!v) return false;
      if(country==='US') return /^\d{5}(-\d{4})?$/.test(v);
      if(country==='CA') return /^[A-Z]\d[A-Z]\s?\d[A-Z]\d$/.test(v);
      return false;
    }
    function readAddress(prefix){
      const country = document.getElementById(prefix+'-country').value || 'US';
      const street1 = document.getElementById(prefix+'-street1').value.trim();
      const street2 = document.getElementById(prefix+'-street2').value.trim();
      const city    = document.getElementById(prefix+'-city').value.trim();
      const state   = (document.getElementById(prefix+'-state').value || '').trim().toUpperCase();
      const postal  = normalizePostal(country, document.getElementById(prefix+'-postal').value);
      if (prefix.includes('origin')) {
        if (!/^[A-Za-z ]+$/.test(city)) {
          return { ok:false, msg:'出发城市只能包含英文字母和空格' };
        }
      }

      if(!street1 || !city || !state || !postal) return {ok:false,msg:'请完整填写地址（街道/城市/州/邮编）'};
      if(!isValidPostal(country, postal)) return {ok:false,msg:'邮编格式不正确（US: 12345/12345-6789；CA: A1A 1A1）'};
      return {ok:true,data:{country,street1,street2:street2||null,city,state,postal}};
    }

    // —— 资料 upsert（优先 RPC，失败降级为直接 upsert 表） ——
    async function saveOrCreateProfile(){
      const payload = {
        p_full_name: document.getElementById('profile-name')?.value?.trim() || null,
        p_phone:     document.getElementById('profile-phone')?.value?.trim() || null,
        p_id_number: document.getElementById('profile-id-number')?.value?.trim() || null,
        p_gender:    document.getElementById('profile-gender')?.value || null,
        p_age:       document.getElementById('profile-age')?.value ? parseInt(document.getElementById('profile-age').value,10) : null,
        p_bio:       document.getElementById('profile-bio')?.value?.trim() || null,
      };
      // 尝试 RPC
      try {
        const { data, error } = await sb.rpc('upsert_my_profile', payload);
        if (error) throw error;
        return data;
      } catch (e) {
        // fallback：直接写表（要求 user_profiles 策略允许本人 upsert）
        const { data: sess } = await sb.auth.getUser();
        const uid = sess?.user?.id;
        const { data, error } = await sb.from('user_profiles').upsert({
          user_id: uid,
          full_name: payload.p_full_name, phone: payload.p_phone, id_number: payload.p_id_number,
          gender: payload.p_gender, age: payload.p_age, bio: payload.p_bio, updated_at: new Date().toISOString()
        }, { onConflict: 'user_id' }).select().single();
        if (error) throw error;
        return data;
      }
    }

    // —— 公告栏数据 —— 
    const boardCache = { drivers: [], passengers: [] };

    function fmtAddr(o){
      const line1 = [o.city, o.state, o.postal].filter(Boolean).join(', ');
      const line2 = [o.street1, o.street2].filter(Boolean).join(' ');
      return { line1, line2 };
    }
    function card(el){
      return `<div class="border rounded-lg p-3 bg-white shadow-sm">${el}</div>`;
    }
    function badge(t){ return `<span class="inline-block text-xs px-2 py-0.5 rounded-full bg-gray-100 border">${t}</span>`; }

    function renderBoard(filterText=''){
      const dWrap = document.getElementById('driver-board');
      const pWrap = document.getElementById('passenger-board');
      const dCount = document.getElementById('driver-count');
      const pCount = document.getElementById('passenger-count');
      const f = (s)=> s.toLowerCase();

      const match = (obj)=>{
        if(!filterText) return true;
        const t = f(filterText);
        const fields = [
          obj.origin_city, obj.origin_state, obj.origin_postal_code,
          obj.destination_city, obj.destination_state, obj.destination_postal_code
        ].filter(Boolean).join(' ').toLowerCase();
        return fields.includes(t);
      };

      const drivers = boardCache.drivers.filter(match);
      const passengers = boardCache.passengers.filter(match);

      dCount.textContent = `${drivers.length} 条`;
      pCount.textContent = `${passengers.length} 条`;

      dWrap.innerHTML = drivers.map(r=>{
          const o = fmtAddr({
            city:   r.origin_city        || r.from_city        || '-',
            state:  r.origin_state       || '-',
            postal: r.origin_postal_code || '',
            street1:r.origin_street1     || '',
            street2:r.origin_street2     || ''
          });
          const d = fmtAddr({
            city:   r.destination_city        || r.to_city           || '-',
            state:  r.destination_state       || '-',
            postal: r.destination_postal_code || '',
            street1:r.destination_street1     || '',
            street2:r.destination_street2     || ''
          });
        const dt = `${r.date} ${r.time?.slice(0,5) || ''}`;
        const price = (r.price_per_person && Number(r.price_per_person)>0) ? `${r.price_per_person}` : '—';
        return card(`
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="flex items-center gap-2 mb-1">${badge('司机')} ${badge('可载 '+r.available_seats+' 人')}</div>
              <div class="text-sm font-medium">出发：${o.line1}</div>
              <div class="text-xs text-gray-500">${o.line2 || ''}</div>
              <div class="text-sm mt-1">到达：${d.line1}</div>
              <div class="text-xs text-gray-500">${d.line2 || ''}</div>
              <div class="text-sm mt-1">时间：${dt}</div>
              <div class="text-sm text-gray-600">价格/人：${price}</div>
              ${r.note ? `<div class="text-xs text-gray-500 mt-1">备注：${r.note}</div>`:''}
            </div>
          </div>
        `);
      }).join('') || '<div class="text-sm text-gray-500">暂无记录</div>';

      pWrap.innerHTML = passengers.map(r=>{
        const o = fmtAddr({
          city:   r.origin_city        || r.from_city        || '-',
          state:  r.origin_state       || '-',
          postal: r.origin_postal_code || '',
          street1:r.origin_street1     || '',
          street2:r.origin_street2     || ''
        });
        const d = fmtAddr({
          city:   r.destination_city        || r.to_city           || '-',
          state:  r.destination_state       || '-',
          postal: r.destination_postal_code || '',
          street1:r.destination_street1     || '',
          street2:r.destination_street2     || ''
          });
        const dt = `${r.date} ${r.time?.slice(0,5) || ''}`;
        return card(`
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="flex items-center gap-2 mb-1">${badge('乘客')} ${badge('需 '+r.seats_needed+' 座')}</div>
              <div class="text-sm font-medium">出发：${o.line1}</div>
              <div class="text-xs text-gray-500">${o.line2 || ''}</div>
              <div class="text-sm mt-1">到达：${d.line1}</div>
              <div class="text-xs text-gray-500">${d.line2 || ''}</div>
              <div class="text-sm mt-1">时间：${dt}</div>
              ${r.note ? `<div class="text-xs text-gray-500 mt-1">备注：${r.note}</div>`:''}
            </div>
          </div>
        `);
      }).join('') || '<div class="text-sm text-gray-500">暂无记录</div>';
    }

    async function loadBoard(){
      // 最近30天到未来90天（你也可以直接删掉时间过滤）
      const now = Date.now();
      const start = new Date(now - 30*24*60*60*1000).toISOString().slice(0,10);
      const end   = new Date(now + 90*24*60*60*1000).toISOString().slice(0,10);
    
      const { data: d, error: de } = await sb.from('driver_schedules')
        .select('*')
        .gte('date', start).lte('date', end)
        .order('date', { ascending: true })
        .order('time', { ascending: true })
        .limit(50);  // 多给点
    
      const { data: p, error: pe } = await sb.from('passenger_requests')
        .select('*')
        .gte('date', start).lte('date', end)
        .order('date', { ascending: true })
        .order('time', { ascending: true })
        .limit(50);
    
      if (de) { console.error('load drivers error', de); toast('加载司机时间表失败：'+de.message,'error'); }
      if (pe) { console.error('load passenger error', pe); toast('加载乘客需求失败：'+pe.message,'error'); }
    
      boardCache.drivers = d || [];
      boardCache.passengers = p || [];
      renderBoard(document.getElementById('board-filter').value.trim());
    }


    // —— 业务提交：乘客 ——
    async function addPassengerRequest(){
      const { data: sess } = await sb.auth.getSession();
      if(!sess?.session){ toast('请先登录', 'error'); return; }

      // 先保存/创建资料（允许为空）
      try { await saveOrCreateProfile(); } catch(e){ toast('保存个人资料失败：'+e.message,'error'); return; }

      const o = readAddress('passenger-origin'); if(!o.ok){ toast(o.msg,'error'); return; }
      const d = readAddress('passenger-dest');   if(!d.ok){ toast(d.msg,'error'); return; }

      const date  = document.getElementById('passenger-date').value;
      const time  = document.getElementById('passenger-time').value;
      const seats = parseInt(document.getElementById('passenger-seats').value,10);
      const note  = document.getElementById('passenger-note').value.trim();

      if(!date || !time || !seats || seats<=0){ toast('日期/时间/座位必填','error'); return; }

      const btn = document.getElementById('add-passenger-request');
      btn.disabled = true; btn.textContent = '提交中…';
      try{
        const { error } = await sb.from('passenger_requests').insert({
          user_id: sess.session.user.id,
          date, time, seats_needed: seats, note,
          origin_country: o.data.country,
          origin_street1: o.data.street1,
          origin_street2: o.data.street2,
          origin_city:    o.data.city,
          origin_state:   o.data.state,
          origin_postal_code: o.data.postal,
          destination_country: d.data.country,
          destination_street1: d.data.street1,
          destination_street2: d.data.street2,
          destination_city:    d.data.city,
          destination_state:   d.data.state,
          destination_postal_code: d.data.postal,
          // 兼容老列（如仍存在）
          from_city: o.data.city, to_city: d.data.city
        });
        if(error) throw error;
        toast('需求发布成功','success');
        // 刷新公告栏
        loadBoard();
      }catch(e){ toast('发布失败：'+e.message,'error'); }
      finally{ btn.disabled=false; btn.textContent='发布需求'; }
    }

    // —— 业务提交：司机 ——
    async function addDriverSchedule(){
      const { data: sess } = await sb.auth.getSession();
      if(!sess?.session){ toast('请先登录','error'); return; }

      try { await saveOrCreateProfile(); } catch(e){ toast('保存个人资料失败：'+e.message,'error'); return; }

      const o = readAddress('driver-origin'); if(!o.ok){ toast(o.msg,'error'); return; }
      const d = readAddress('driver-dest');   if(!d.ok){ toast(d.msg,'error'); return; }

      const date  = document.getElementById('driver-date').value;
      const time  = document.getElementById('driver-time').value;
      const seats = parseInt(document.getElementById('driver-seats').value,10);
      const price = parseFloat(document.getElementById('driver-price').value) || 0;
      const note  = document.getElementById('driver-note').value.trim();

      if(!date || !time || !seats || seats<=0){ toast('日期/时间/座位必填','error'); return; }

      const btn = document.getElementById('add-driver-schedule');
      btn.disabled = true; btn.textContent = '提交中…';
      try{
        const { error } = await sb.from('driver_schedules').insert({
          user_id: sess.session.user.id,
          date, time, available_seats: seats, price_per_person: isNaN(price)?0:price, note,
          origin_country: o.data.country,
          origin_street1: o.data.street1,
          origin_street2: o.data.street2,
          origin_city:    o.data.city,
          origin_state:   o.data.state,
          origin_postal_code: o.data.postal,
          destination_country: d.data.country,
          destination_street1: d.data.street1,
          destination_street2: d.data.street2,
          destination_city:    d.data.city,
          destination_state:   d.data.state,
          destination_postal_code: d.data.postal,
          from_city: o.data.city, to_city: d.data.city
        });
        if(error) throw error;
        toast('时间表发布成功','success');
        loadBoard();
      }catch(e){ toast('发布失败：'+e.message,'error'); }
      finally{ btn.disabled=false; btn.textContent='发布时间表'; }
    }

    // —— 资料单独保存按钮（可选） ——
    async function saveProfileButton(){
      const { data: sess } = await sb.auth.getSession();
      if(!sess?.session){ toast('请先登录','error'); return; }
      try{ await saveOrCreateProfile(); toast('资料已保存','success'); }
      catch(e){ toast('保存失败：'+e.message,'error'); }
    }

    // —— Auth 相关 ——
    async function login(){
      const email = document.getElementById('authEmail').value.trim();
      const pass  = document.getElementById('authPass').value.trim();
      if(!email || !pass){ toast('请输入邮箱与密码','error'); return; }
      const btn = document.getElementById('btnLogin'); btn.disabled=true; btn.textContent='登录中…';
      try{
        const { error } = await sb.auth.signInWithPassword({ email, password: pass });
        if(error) throw error;
        toast('登录成功','success');
      }catch(e){ toast('登录失败：'+(e.message||'Bad Request'),'error'); }
      finally{ btn.disabled=false; btn.textContent='登录'; }
    }
    async function register(){
      const email = document.getElementById('authEmail').value.trim();
      const pass  = document.getElementById('authPass').value.trim();
      if(!email || !pass){ toast('请输入邮箱与密码','error'); return; }
      const btn = document.getElementById('btnRegister'); btn.disabled=true; btn.textContent='注册中…';
      try{
        const { data, error } = await sb.auth.signUp({ email, password: pass });
        if(error) throw error;
        if(data.user && !data.session) toast('注册成功！请到邮箱点击确认链接后再登录','success');
        else toast('注册成功！','success');
      }catch(e){ toast('注册失败：'+(e.message||'Database error'),'error'); }
      finally{ btn.disabled=false; btn.textContent='注册'; }
    }
    async function magicLink(){
      const email = document.getElementById('authEmail').value.trim();
      if(!email){ toast('请输入邮箱','error'); return; }
      const btn = document.getElementById('btnMagic'); btn.disabled=true; btn.textContent='发送中…';
      try{
        const redirect = location.href;
        const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: redirect } });
        if(error) throw error;
        toast('已发送登录链接，请查收邮箱','success');
      }catch(e){ toast('发送失败：'+(e.message||'配置错误（检查 Redirect URLs）'),'error'); }
      finally{ btn.disabled=false; btn.textContent='发登录链接'; }
    }
    async function signOut(){
      await sb.auth.signOut(); toast('已退出','success');
    }

    // —— 初始化与事件绑定 ——
    document.getElementById('nav-board').addEventListener('click', ()=>{ showSection('board'); loadBoard(); });
    document.getElementById('nav-passenger').addEventListener('click', ()=>{
      showSection('passenger');
      loadDriversList();
    });
    document.getElementById('nav-driver').addEventListener('click', ()=>{
      showSection('driver');
      loadPassengersList();
    });
    document.getElementById('driver-filter').addEventListener('input', e => renderDriversList(e.target.value.trim()));
    document.getElementById('btnDriversRefresh').addEventListener('click', loadDriversList);
    
    document.getElementById('passenger-filter').addEventListener('input', e => renderPassengersList(e.target.value.trim()));
    document.getElementById('btnPassengersRefresh').addEventListener('click', loadPassengersList);

    document.getElementById('btnLogin').addEventListener('click', login);
    document.getElementById('btnRegister').addEventListener('click', register);
    document.getElementById('btnMagic').addEventListener('click', magicLink);
    document.getElementById('btnSignOut').addEventListener('click', signOut);
    document.getElementById('btnEditProfile').addEventListener('click', ()=>showSection('profile'));
    document.getElementById('btnSaveProfile').addEventListener('click', saveProfileButton);
    document.getElementById('add-passenger-request').addEventListener('click', addPassengerRequest);
    document.getElementById('add-driver-schedule').addEventListener('click', addDriverSchedule);
    document.getElementById('btnBoardRefresh').addEventListener('click', loadBoard);
    document.getElementById('board-filter').addEventListener('input', (e)=> renderBoard(e.target.value.trim()));

    // 会话恢复
    (async ()=>{
      const { data:{ session } } = await sb.auth.getSession();
      updateAuthUI(session);
    })();

    // 监听会话变更
    sb.auth.onAuthStateChange((_evt, session)=> updateAuthUI(session));

    // Realtime（可选：需在 Supabase 启用 Realtime 复制）
    let rtSub = null;
    function setupRealtime(){
      try{
        if(rtSub) { sb.removeChannel(rtSub); rtSub=null; }
        rtSub = sb.channel('board-ch')
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'driver_schedules' }, () => loadBoard())
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'driver_schedules' }, () => loadBoard())
          .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'driver_schedules' }, () => loadBoard())
          .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'passenger_requests' }, () => loadBoard())
          .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'passenger_requests' }, () => loadBoard())
          .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'passenger_requests' }, () => loadBoard())
          .subscribe((s)=>{ /* console.log('Realtime status', s); */ });
      }catch(e){ console.warn('Realtime unavailable', e); }
    }

    function updateAuthUI(session){
      const authed = !!session?.user;
      document.getElementById('authStatus').textContent = authed ? `已登录：${session.user.email}` : '未登录';
      document.getElementById('authBox').classList.toggle('hidden', authed);
      document.getElementById('btnSignOut').classList.toggle('hidden', !authed);
      document.getElementById('btnEditProfile').classList.toggle('hidden', !authed);
    
      // 任何人都先看到公告栏
      showSection('board');
      // 都加载一次公告数据（RLS 已放开读取）
      loadBoard();
    
      // Realtime（如果你开启了并允许 anon 订阅，可以保留；否则保留也不会影响读取）
      try { setupRealtime(); } catch (_) {}
    }

    // —— 分页缓存 —— 
const listCache = { drivers: [], passengers: [] };

// 工具：格式化地址、卡片、徽标（复用你已有的函数即可，如已存在可忽略）
function fmtAddr(o){
  const line1 = [o.city, o.state, o.postal].filter(Boolean).join(', ');
  const line2 = [o.street1, o.street2].filter(Boolean).join(' ');
  return { line1, line2 };
}
function card(el){ return `<div class="border rounded-lg p-3 bg-white shadow-sm">${el}</div>`; }
function badge(t){ return `<span class="inline-block text-xs px-2 py-0.5 rounded-full bg-gray-100 border">${t}</span>`; }

// 渲染：可用司机（乘客页用）
function renderDriversList(filterText=''){
  const wrap = document.getElementById('driver-list');
  if(!wrap) return;
  const t = (filterText||'').toLowerCase();
  const rows = listCache.drivers.filter(r=>{
    if(!t) return true;
    const s = [
      r.origin_city || r.from_city, r.origin_state, r.origin_postal_code,
      r.destination_city || r.to_city, r.destination_state, r.destination_postal_code
    ].filter(Boolean).join(' ').toLowerCase();
    return s.includes(t);
  });
  wrap.innerHTML = rows.map(r=>{
    const o = fmtAddr({
      city: r.origin_city || r.from_city || '-', state: r.origin_state || '-', postal: r.origin_postal_code || '',
      street1: r.origin_street1 || '', street2: r.origin_street2 || ''
    });
    const d = fmtAddr({
      city: r.destination_city || r.to_city || '-', state: r.destination_state || '-', postal: r.destination_postal_code || '',
      street1: r.destination_street1 || '', street2: r.destination_street2 || ''
    });
    const dt = `${r.date} ${r.time?.slice(0,5) || ''}`;
    const price = (r.price_per_person && Number(r.price_per_person)>0) ? `${r.price_per_person}` : '—';
    return card(`
      <div>
        <div class="flex items-center gap-2 mb-1">${badge('司机')} ${badge('可载 '+r.available_seats+' 人')}</div>
        <div class="text-sm font-medium">出发：${o.line1}</div>
        <div class="text-xs text-gray-500">${o.line2 || ''}</div>
        <div class="text-sm mt-1">到达：${d.line1}</div>
        <div class="text-xs text-gray-500">${d.line2 || ''}</div>
        <div class="text-sm mt-1">时间：${dt}</div>
        <div class="text-sm text-gray-600">价格/人：${price}</div>
        ${r.note ? `<div class="text-xs text-gray-500 mt-1">备注：${r.note}</div>`:''}
      </div>
    `);
  }).join('') || '<div class="text-sm text-gray-500">暂无记录</div>';
}

// 渲染：乘客需求（司机页用）
function renderPassengersList(filterText=''){
  const wrap = document.getElementById('passenger-list');
  if(!wrap) return;
  const t = (filterText||'').toLowerCase();
  const rows = listCache.passengers.filter(r=>{
    if(!t) return true;
    const s = [
      r.origin_city || r.from_city, r.origin_state, r.origin_postal_code,
      r.destination_city || r.to_city, r.destination_state, r.destination_postal_code
    ].filter(Boolean).join(' ').toLowerCase();
    return s.includes(t);
  });
  wrap.innerHTML = rows.map(r=>{
    const o = fmtAddr({
      city: r.origin_city || r.from_city || '-', state: r.origin_state || '-', postal: r.origin_postal_code || '',
      street1: r.origin_street1 || '', street2: r.origin_street2 || ''
    });
    const d = fmtAddr({
      city: r.destination_city || r.to_city || '-', state: r.destination_state || '-', postal: r.destination_postal_code || '',
      street1: r.destination_street1 || '', street2: r.destination_street2 || ''
    });
    const dt = `${r.date} ${r.time?.slice(0,5) || ''}`;
    return card(`
      <div>
        <div class="flex items-center gap-2 mb-1">${badge('乘客')} ${badge('需 '+r.seats_needed+' 座')}</div>
        <div class="text-sm font-medium">出发：${o.line1}</div>
        <div class="text-xs text-gray-500">${o.line2 || ''}</div>
        <div class="text-sm mt-1">到达：${d.line1}</div>
        <div class="text-xs text-gray-500">${d.line2 || ''}</div>
        <div class="text-sm mt-1">时间：${dt}</div>
        ${r.note ? `<div class="text-xs text-gray-500 mt-1">备注：${r.note}</div>`:''}
      </div>
    `);
  }).join('') || '<div class="text-sm text-gray-500">暂无记录</div>';
}

// 载入：司机（给乘客页）
async function loadDriversList(){
  const now = Date.now();
  const start = new Date(now - 30*24*60*60*1000).toISOString().slice(0,10);
  const end   = new Date(now + 90*24*60*60*1000).toISOString().slice(0,10);

  const { data, error } = await sb.from('driver_schedules')
    .select('*')
    .gte('date', start).lte('date', end)
    .order('date', { ascending: true })
    .order('time', { ascending: true })
    .limit(50);
  if (error) { console.error(error); toast('加载司机时间表失败：'+error.message,'error'); return; }

  listCache.drivers = data || [];
  renderDriversList(document.getElementById('driver-filter')?.value?.trim());
}

// 载入：乘客（给司机页）
async function loadPassengersList(){
  const now = Date.now();
  const start = new Date(now - 30*24*60*60*1000).toISOString().slice(0,10);
  const end   = new Date(now + 90*24*60*60*1000).toISOString().slice(0,10);

  const { data, error } = await sb.from('passenger_requests')
    .select('*')
    .gte('date', start).lte('date', end)
    .order('date', { ascending: true })
    .order('time', { ascending: true })
    .limit(50);
  if (error) { console.error(error); toast('加载乘客需求失败：'+error.message,'error'); return; }

  listCache.passengers = data || [];
  renderPassengersList(document.getElementById('passenger-filter')?.value?.trim());
}

    

  </script>
</body>
</html>
