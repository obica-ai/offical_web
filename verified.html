<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é‚®ç®±éªŒè¯ç»“æœ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div class="max-w-md mx-auto mt-20 bg-white border rounded-xl shadow-sm p-6 text-center">
    <div id="icon" class="text-5xl mb-3">ğŸ”„</div>
    <h1 id="title" class="text-xl font-semibold mb-1">æ­£åœ¨ç¡®è®¤é‚®ç®±é“¾æ¥â€¦</h1>
    <p id="desc" class="text-gray-600 text-sm">è¯·ç¨ç­‰ç‰‡åˆ»</p>

    <div class="mt-6 flex justify-center gap-3">
      <a id="btnHome" href="/travel_web/" class="px-4 py-2 rounded-md border">è¿”å›é¦–é¡µ</a>
      <a id="btnApp"  href="/travel_web/index.html" class="px-4 py-2 rounded-md bg-blue-600 text-white">è¿›å…¥åº”ç”¨</a>
    </div>
  </div>

  <script>
    // â€”â€” å¯é€‰ï¼šæ”¯æŒ ?sbUrl=...&sbKey=... è¦†ç›–ï¼ˆä¸ä½  index.html çš„åšæ³•ä¸€è‡´ï¼‰ â€”â€”
    (function(){
      try{
        const usp = new URLSearchParams(location.search);
        const u = usp.get('sbUrl'); const k = usp.get('sbKey');
        if(u && k){ window.SUPABASE_URL = u; window.SUPABASE_ANON_KEY = k; }
      }catch(e){}
    })();

    // â€”â€” æ›¿æ¢ä¸ºä½ çš„é¡¹ç›® â€”â€”ï¼ˆå’Œ index.html ä¿æŒä¸€è‡´ï¼‰
    const SUPABASE_URL = window.SUPABASE_URL || 'https://ddycdlhhgezffmybssvw.supabase.co';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkeWNkbGhoZ2V6ZmZteWJzc3Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NDA4MzAsImV4cCI6MjA3MjExNjgzMH0.JAU94T7uUZQCvuXtaZbMc3VXTAKQyprTX0H62AGOtyo';

    const sb = (typeof supabase!=='undefined') ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

    const $ = (id)=>document.getElementById(id);
    function show(ok, title, desc){
      $('icon').textContent = ok ? 'âœ…' : 'âš ï¸';
      $('title').textContent = title;
      $('desc').textContent  = desc || '';
    }

    (async function main(){
      try{
        // å¤„ç†ä¸¤ç§å›è°ƒå½¢å¼ï¼š
        // 1) OAuth/éƒ¨åˆ†é‚®ä»¶ï¼š?code=...ï¼ˆéœ€è¦ exchangeCodeForSessionï¼‰
        // 2) Magic link/é‚®ä»¶ç¡®è®¤ï¼šURL hash å¸¦ access_token / refresh_tokenï¼ˆåº“ä¼šè‡ªåŠ¨è§£æï¼‰
        const usp = new URLSearchParams(location.search);
        const code = usp.get('code');
        const errd = usp.get('error_description');

        if (errd) {
          show(false, 'éªŒè¯å¤±è´¥', decodeURIComponent(errd));
          return;
        }

        if (code) {
          // ä»¥ code äº¤æ¢ä¼šè¯ï¼ˆå¦‚æŸäº›é‚®ä»¶/SSO æµç¨‹ï¼‰
          try {
            await sb.auth.exchangeCodeForSession({ code });
          } catch (e) {
            show(false, 'éªŒè¯å¤±è´¥', e.message || 'exchangeCodeForSession å‡ºé”™');
            return;
          }
        } else {
          // æ²¡æœ‰ codeï¼šè‹¥æ˜¯ magic link / confirm emailï¼Œsupabase-js ä¼šè‡ªåŠ¨ä» URL hash æ¢å¤ä¼šè¯
          // ç¨ç­‰ä¸€æ‹å†è¯»ä¼šè¯
          await new Promise(r=>setTimeout(r, 50));
        }

        const { data: { session }, error } = await sb.auth.getSession();
        if (error) throw error;

        // æ ¹æ®å›è°ƒç±»å‹å±•ç¤ºä¸åŒæç¤ºï¼ˆå¯ä» hash æˆ– query é‡Œå– typeï¼‰
        const hash = new URLSearchParams(location.hash.substring(1));
        const typ  = hash.get('type') || usp.get('type') || 'verified';

        const email = session?.user?.email;
        const who = email ? `ï¼ˆ${email}ï¼‰` : '';

        if (session) {
          if (typ === 'signup') {
            show(true, 'æ³¨å†Œé‚®ç®±éªŒè¯æˆåŠŸ ğŸ‰', 'ä½ çš„é‚®ç®±å·²ç¡®è®¤'+who+'ï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨å•¦');
          } else if (typ === 'magiclink') {
            show(true, 'ç™»å½•æˆåŠŸ ğŸ‰', 'å·²é€šè¿‡é‚®ç®±é“¾æ¥å®Œæˆç™»å½•'+who);
          } else if (typ === 'recovery') {
            show(true, 'å¯†ç é‡ç½®æˆåŠŸ âœ…', 'ä½ å·²é€šè¿‡é‚®ä»¶é“¾æ¥å®Œæˆç™»å½•'+who);
          } else {
            show(true, 'é‚®ç®±éªŒè¯æˆåŠŸ ğŸ‰', 'ä¼šè¯å·²å»ºç«‹'+who);
          }
        } else {
          show(false, 'æœªèƒ½å»ºç«‹ä¼šè¯', 'é“¾æ¥å¯èƒ½å·²å¤±æ•ˆæˆ–å·²è¢«ä½¿ç”¨ï¼Œè¯·é‡æ–°å‘é€ç™»å½•/éªŒè¯é‚®ä»¶');
        }
      }catch(e){
        show(false, 'éªŒè¯å¤±è´¥', e.message || 'æœªçŸ¥é”™è¯¯');
      }
    })();

    function getSavedEmail(){ try{ return localStorage.getItem('lastEmail')||'' }catch{ return '' } }

async function resendLink(){
  const email = prompt('è¯·è¾“å…¥é‚®ç®±ä»¥é‡å‘ç™»å½•é“¾æ¥ï¼š', getSavedEmail());
  if(!email) return;
  await sb.auth.signInWithOtp({
    email,
    options:{ emailRedirectTo:'https://obica-ai.github.io/travel_web/verified.html' }
  });
  show(true, 'å·²å‘é€æ–°çš„ç™»å½•é“¾æ¥', 'è¯·ç‚¹å‡»æœ€æ–°é‚£å°é‚®ä»¶ï¼›ä¹Ÿå¯ç›´æ¥ç”¨é‚®ä»¶ä¸­çš„ 6 ä½éªŒè¯ç ç™»å½•');
}

function showOtpBox(){
  const box = document.createElement('div');
  box.className='mt-4 flex justify-center gap-2';
  box.innerHTML=`
    <input id="otp" maxlength="6" class="px-3 py-2 border rounded-md w-28 text-center" placeholder="6ä½éªŒè¯ç ">
    <button id="btnOtp" class="px-4 py-2 rounded-md bg-blue-600 text-white">ç”¨éªŒè¯ç ç™»å½•</button>
  `;
  document.querySelector('.p-6').appendChild(box);
  document.getElementById('btnOtp').onclick = async ()=>{
    const email = prompt('è¯·è¾“å…¥ä½ çš„é‚®ç®±ï¼š', getSavedEmail());
    const otp   = document.getElementById('otp').value.trim();
    if(!email || !otp){ return; }
    try{
      // ä¼˜å…ˆå°è¯•â€œé‚®ä»¶éªŒè¯ç â€ç±»å‹ï¼›ä¸è¡Œå†å›é€€ magiclink
      try{
        await sb.auth.verifyOtp({ email, token: otp, type: 'email' });
      }catch(_){
        await sb.auth.verifyOtp({ email, token: otp, type: 'magiclink' });
      }
      show(true,'ç™»å½•æˆåŠŸ ğŸ‰','å·²é€šè¿‡éªŒè¯ç å®Œæˆç™»å½•');
      setTimeout(()=>location.href='/travel_web/index.html', 1200);
    }catch(e){
      show(false,'éªŒè¯ç ç™»å½•å¤±è´¥', e.message||'');
    }
  };
}

function showErrorAndResend(msg){
  show(false,'æœªèƒ½å»ºç«‹ä¼šè¯', msg||'é“¾æ¥å¯èƒ½å·²å¤±æ•ˆæˆ–è¢«é‚®ç®±æœºå™¨äººç‚¹è¿‡äº†');
  const btn = document.createElement('button');
  btn.className='mt-4 px-4 py-2 rounded-md bg-blue-600 text-white';
  btn.textContent='é‡æ–°å‘é€ç™»å½•é“¾æ¥';
  btn.onclick=resendLink;
  document.querySelector('.p-6').appendChild(btn);
  showOtpBox(); // åŒæ—¶ç»™å‡ºâ€œè¾“å…¥éªŒè¯ç ç™»å½•â€
}

    
  </script>
</body>
</html>
